--To dp 
-- Modify triggers 
-- Run all the file at once without erros

--drop the VIEW
Drop view VIEW_RES;
Drop view VIEW_TOUR;

-- Drop the triggers
DROP TRIGGER CHECKSEVEN;
Drop TRIGGER CUSTOMER_TRANS;
DROP TRIGGER reservation_TRANS;

-- Drop the tables
DROP TABLE Login;
Drop Table agent_session;
DROP TABLE ARRANGES;
DROP TABLE CONSIST_OF;
DROP TABLE SCHEDULE_STOPS;
DROP TABLE SCHEDULE;
DROP TABLE RESERVATION;
Drop TABLE CONTAINS;
DROP TABLE Tour_Trip;
DROP TABLE TOUR_PACKAGE;
DROP TABLE Transaction;
DROP TABLE Guide_Languages;
DROP TABLE QTA_Agent;
DROP TABLE Tour_Site;
DROP TABLE Customer;
DROP TABLE Guide;

CREATE TABLE agent_session (
    agent_id NUMBER(10),
    username VARCHAR2(20)
);



CREATE TABLE Customer (
    CustID NUMBER(10)NOT NULL,
    FName VARCHAR2(20) NOT NULL,
    LName VARCHAR2(20) NOT NULL,
    Email VARCHAR2(50)NOT NULL UNIQUE,
    Phone NUMBER(10)NOT NULL UNIQUE,
    City VARCHAR2(12)NOT NULL,
    Street VARCHAR2(10)NOT NULL,
    Building VARCHAR2(10)NOT NULL, 
    CONSTRAINT CUST_ID_PK PRIMARY KEY (CUSTID)
);


INSERT INTO Customer VALUES(122, 'Omar', 'Mohamed', 'OKAOA@GMAIL.COM', 30191910, 'DOHA', 'BBBB', '122');
INSERT INTO Customer VALUES(123, 'Ahmed', 'Ali', 'AHMEDALI@GMAIL.COM', 30202020, 'ALWAKRAH', 'CCCC', '123');
INSERT INTO Customer VALUES(124, 'Fatima', 'Abdullah', 'FATIMAABDULLAH@GMAIL.COM', 30303030, 'ALKHOR', 'DDDD', '124');
INSERT INTO Customer VALUES(125, 'Nadia', 'Ibrahim', 'NADIAIBRAHIM@GMAIL.COM', 30404040, 'RIYADH', 'EEEE', '125');
INSERT INTO Customer VALUES(126, 'Khaled', 'Yousef', 'KHALEDYOUSEF@GMAIL.COM', 30505050, 'DOHA', 'FFFF', '126');

SELECT * FROM CUSTOMER;

CREATE TABLE Tour_Site (
    SName VARCHAR2(40) ,
    LOC VARCHAR2(50) ,
    NearLMark VARCHAR2(20) ,
    CONSTRAINT site_pk PRIMARY KEY (SName),
    CONSTRAINT sites_names CHECK (SName IN ('Simaisma', 'Qatar Museum', 'Banana Island'))
);

SELECT * FROM CUSTOMER;

INSERT INTO Tour_Site VALUES('Simaisma','Simaisma Town','beach');
INSERT INTO Tour_Site VALUES('Qatar Museum','Qatar Museum Location','Doha Corniche');
INSERT INTO Tour_Site VALUES('Banana Island','Banana Island Resort','Doha Port');

CREATE TABLE Guide (
    Guide_ID NUMBER(10) ,
    Fname varchar2(10) NOT NULL,
    Lname varchar2(10) NOT NULL,
    CONSTRAINT GuideTable_pk PRIMARY KEY(Guide_ID)
    
);


INSERT INTO GUIDE VALUES(123,'MOHAMED','MOHAMED');
INSERT INTO GUIDE VALUES(321,'khalid','ahmed');
INSERT INTO GUIDE VALUES(715,'abdu','omar');
INSERT INTO GUIDE VALUES(32881,'saleh','mohammed');
INSERT INTO GUIDE VALUES(32455,'mohammed','saleh');



CREATE TABLE Guide_Languages(
    GuideID NUMBER(10) REFERENCES Guide(Guide_ID),
    LANGS VARCHAR2(20) UNIQUE NOT NULL,
    PRIMARY KEY (GuideID, LANGS),
    CONSTRAINT LANG_CHK CHECK( LANGS IN ('ENGLISH' , 'ARBAIC','URDU', 'FRENCH'))    
);



CREATE TABLE TOUR_PACKAGE (
    PACKID NUMBER(2),
    TYP VARCHAR2(20),
    PRICE NUMBER(10,2),
    DURA VARCHAR2(10),
    CONSTRAINT PACK_ID_PK PRIMARY KEY (PACKID)
);


INSERT INTO TOUR_PACKAGE VALUES (1,'Entertainment',200,'5hrs'); 
INSERT INTO TOUR_PACKAGE VALUES (2,'Site Seeing',100,'5hrs');
INSERT INTO TOUR_PACKAGE VALUES (3,'Island Visits',500,'10hrs'); 
INSERT INTO TOUR_PACKAGE VALUES (4,'Entertainment',200,'5hrs');
INSERT INTO TOUR_PACKAGE VALUES (5,'Site Seeing',100,'5hrs'); 

/*modifed by ayoub on 4 may @5pm: i deleted contains table and added the packid here, "a trip can be only in one pack, a pack can have multiple trips" therefore the pack id should be here*/

CREATE TABLE Tour_Trip (
    TourNo NUMBER(10),
    TripDate DATE,
    PACKID  NUMBER(2),
    Guide_ID NUMBER(10),
    Destination VARCHAR2(50),
    Price NUMBER(10),
    Start_Time TIMESTAMP,
    Duration NUMBER(10),
    Location VARCHAR2(50),
    CONSTRAINT PK_TourNo_DATE PRIMARY KEY(TourNo,TRIPDATE),
    CONSTRAINT PACKID__FK FOREIGN KEY(PACKID) REFERENCES TOUR_PACKAGE (PACKID),
    CONSTRAINT Guide_ID_FK FOREIGN KEY(Guide_ID) REFERENCES Guide(Guide_ID)
);

INSERT INTO TOUR_TRIP VALUES (1235, TO_DATE('12-12-2024', 'dd-mm-yyyy'), 1, 123, 'AAQ', 123, SYSTIMESTAMP, 0, 'DOHA');
INSERT INTO TOUR_TRIP VALUES (123, TO_DATE('01-01-2001', 'dd-mm-yyyy'), 1, 123, 'AAQ', 123, SYSTIMESTAMP, 0, 'DOHA');




CREATE TABLE Transaction ( 
    trans_date DATE NOT NULL,
    username VARCHAR2(20),
    agentID NUMBER(5)
);



CREATE TABLE QTA_Agent (  
    Agent_ID NUMBER(10),
    Fname VARCHAR2(10) NOT NULL,
    Lname VARCHAR2(10) NOT NULL,
    CUSTID NUMBER(10) NOT NULL,
    CONSTRAINT AGENT_TABLE_PK PRIMARY KEY (Agent_ID),
    CONSTRAINT CUST_FK FOREIGN KEY (CUSTID) REFERENCES CUSTOMER(CUSTID)
);

select user from dual;


INSERT INTO QTA_AGENT VALUES(1,'HASSAN','HUSSEIN',122);


ALTER TABLE Transaction ADD CONSTRAINT fk_agentID FOREIGN KEY (agentID) REFERENCES QTA_Agent(Agent_ID);


CREATE TABLE Login (
    Username varchar2(20),
    Password VARCHAR2(50),
    AGENTID NUMBER(10) REFERENCES QTA_AGENT(AGENT_ID),
    PRIMARY KEY (Username)

);

select * from TOUR_TRIP;
INSERT INTO LOGIN VALUES('HUSS123','12345',1);
INSERT INTO LOGIN VALUES('mohammed','123456',1);
INSERT INTO LOGIN VALUES('ahmed11','1234567',1);
INSERT INTO LOGIN VALUES('nader','12345678',1);
INSERT INTO LOGIN VALUES('khalid12','123456789',1);


CREATE TABLE RESERVATION (
    ResvNO number(10),
    ResvDate DATE,
    Statues VARCHAR2(10),
    CustID  NUMBER(10),
    Agent_ID NUMBER(10),
    TourNo NUMBER(10),
    TripDate date,
    CONSTRAINT resvno_pk PRIMARY KEY(ResvNo),
    CONSTRAINT TOURNO_FK FOREIGN KEY(TourNo,TripDate) REFERENCES TOUR_TRIP(TourNo,TripDate),
    CONSTRAINT AGENT_FK FOREIGN KEY (Agent_ID) REFERENCES QTA_AGENT(AGENT_ID),
    CONSTRAINT CUST_RES_FK FOREIGN KEY (CUSTID) REFERENCES Customer(CUSTID) ,
    CONSTRAINT STSCHK CHECK(STATUES IN ('CONFIRMED','CANCELLED'))
    /*reservation must be made 7 days prior to the tour trip date.*/ 
); 

SELECT * FROM RESERVATION;
SELECT * FROM QTA_AGENT;

CREATE TABLE SCHEDULE (
    GUIDEID NUMBER(10) PRIMARY KEY,
    TRIPDATE DATE,
    TOURNO NUMBER(10),
    CONSTRAINT guide_FK FOREIGN KEY (GUIDEID) REFERENCES GUIDE(GUIDE_ID),
    CONSTRAINT trip_fk FOREIGN KEY (TOURNO,TripDate) REFERENCES Tour_Trip(TOURNO,TripDate)
    
);


INSERT INTO SCHEDULE VALUES (123, TO_DATE('01-01-2001', 'dd-mm-yyyy'), 123);

/*modified by ayoub in 4 may @4:55pm */
CREATE TABLE SCHEDULE_STOPS (
    GuideID NUMBER(10),
    TOURNO NUMBER(10),
    TripDate DATE,
    StopPoint VARCHAR2(20),
    CONSTRAINT schedule_points_pk PRIMARY KEY (GuideID, TOURNO, TripDate, StopPoint),
    CONSTRAINT Tourtrip_fk FOREIGN KEY (TOURNO,TripDate) REFERENCES Tour_Trip(TOURNO,TripDate),
    CONSTRAINT fk_guide_in_Schedule_stops FOREIGN KEY (GUIDEID) REFERENCES GUIDE(GUIDE_ID)
);



select * from TOUR_TRIP;

/*modified by ayoub on 4 may @ 5:30pm*/
CREATE TABLE CONSIST_OF (
    TOUR_NUMBER NUMBER(10),
    TOUR_DATE DATE,
    S_NAME VARCHAR(40),
    CONSTRAINT PK_TOUR_S_NAME PRIMARY KEY (TOUR_NUMBER, TOUR_DATE, S_NAME),
    CONSTRAINT TOUR_NUMBER_FK FOREIGN KEY (TOUR_NUMBER,TOUR_DATE) REFERENCES TOUR_TRIP(TourNo,TRIPDATE),
    CONSTRAINT S_NAME_FK FOREIGN KEY (S_NAME) REFERENCES TOUR_SITE(SNAME)
);

SELECT * from TOUR_TRIP;
INSERT INTO CONSIST_OF (TOUR_NUMBER,TOUR_DATE, S_NAME) VALUES (1235,TO_DATE('12-12-2024', 'DD-MM-YYYY') ,'Banana Island');
INSERT INTO CONSIST_OF (TOUR_NUMBER,TOUR_DATE, S_NAME) VALUES (123, TO_DATE('01-jan-01', 'dd-mon-yy'),'Qatar Museum');
INSERT INTO CONSIST_OF (TOUR_NUMBER,TOUR_DATE, S_NAME) VALUES (1235, TO_DATE('12-DEC-24', 'dd-mon-yy'),'Qatar Museum');
INSERT INTO CONSIST_OF (TOUR_NUMBER,TOUR_DATE, S_NAME) VALUES (123, TO_DATE('01-jan-01', 'dd-mon-yy'),'Banana Island');
INSERT INTO CONSIST_OF (TOUR_NUMBER,TOUR_DATE, S_NAME) VALUES (1235,TO_DATE('12-12-24', 'dd-MM-yy'),'Simaisma');


create table CONTAINS(
    PACKID number(2),
    Tour_number NUMBER(10),
    TRIPDATE date,
    CONSTRAINT contains_pk PRIMARY KEY (PACKID,Tour_number,TRIPDATE),
    CONSTRAINT fk_tou_trip FOREIGN KEY(Tour_number, TRIPDATE) REFERENCES TOUR_TRIP(TOURNO,TRIPDATE),
    CONSTRAINT packid_fk FOREIGN KEY(PACKID) REFERENCES TOUR_PACKAGE(PACKID)
);

select * from TOUR_TRIP;

CREATE TABLE ARRANGES (
    GUIDE_ID NUMBER(10),
    TOUR_NO NUMBER(10),
    TOUR_DATE DATE,
    CONSTRAINT GUIDE_FK_in_Arranges FOREIGN KEY (GUIDE_ID) REFERENCES GUIDE(GUIDE_ID),
    CONSTRAINT TOUR_NO_DATE_FK FOREIGN KEY (TOUR_NO, TOUR_DATE) REFERENCES TOUR_TRIP(TOURNO, TRIPDATE)
);

INSERT INTO ARRANGES VALUES (123, 123, TO_DATE('01-01-2001', 'dd-mm-yyyy'));

/*modifed by ayoub on 4may @ 5:40pm*/
-- CREATE OR REPLACE TRIGGER CHECKSEVEN
-- BEFORE INSERT OR UPDATE ON RESERVATION
-- FOR EACH ROW    
-- BEGIN
--     IF MONTHS_BETWEEN(SYSDATE, :new.TRIPDATE) > (7/30) THEN
--         RAISE_APPLICATION_ERROR(-20010, 'THE RESERVATION MUST BE 7 DAYS PRIOR THE TRIP DATE');
--     END IF;
-- END;
-- /

CREATE TRIGGER CUSTOMER_TRANS
AFTER INSERT OR UPDATE OR DELETE ON customer
FOR EACH ROW
    DECLARE 
    agent_id NUMBER(10);
    username VARCHAR2(20);
BEGIN

    SELECT AGENT_ID, USERNAME INTO agent_id, username
    FROM agent_session;

    INSERT INTO TRANSACTION (trans_date, username, agentId)
    VALUES (SYSDATE, username, agent_id);
END;
/

CREATE TRIGGER reservation_TRANS
AFTER INSERT OR UPDATE OR DELETE ON reservation
FOR EACH ROW
    DECLARE 
    agent_id NUMBER(10);
    username VARCHAR2(20);
BEGIN

    SELECT AGENT_ID, USERNAME INTO agent_id, username
    FROM agent_session;

    INSERT INTO TRANSACTION (trans_date, username, agentId)
    VALUES (SYSDATE, username, agent_id);
END;

/

INSERT
INTO GUIDE_LANGUAGES
VALUES (123,'ENGLISH');


CREATE VIEW VIEW_RES AS
SELECT * FROM RESERVATION;


CREATE VIEW VIEW_TOUR AS
SELECT * FROM Tour_Trip;




SELECT * FROM CUSTOMER;
SELECT * FROM AGENT_SESSION;



SELECT * FROM TOUR_TRIP;

SELECT * FROM RESERVATION;


SELECT * FROM VIEW_TOUR;